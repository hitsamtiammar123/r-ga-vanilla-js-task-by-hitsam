<html>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://rga.com/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>R/GA Vanilla JavaScript exercise by Hitsam</title>

    <script src="https://unpkg.com/deck.gl@^8.8.0/dist.min.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


    <style type="text/css">
      body {margin: 0; padding: 0;}
      #container {width: 100vw; height: 100vh;}
      .datepickerContainer{
        position: absolute;
        z-index: 1;
        width: 100%;
        bottom: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .datepicker{
        display: flex;
        width: 300px;
        flex-direction: column;
      }

      .backdrop{
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: gray;
        opacity: 0.5;
        display: none;
        z-index: 1;
        align-items: center;
        justify-content: center;
      }

    </style>
  </head>

  <body>
    <div id="container"></div>
    <div class="datepickerContainer">
      <div class="datepicker">
        <input id="my-datepicker"/>
        <span id="total-taxi">Total Taxi: 0</span>
        <span id="timestamp-taxi">Timestamp: -</span>
      </div>
    </div>
    <div class="backdrop">
      <img src="loading.svg" width="200px" height="200px" alt="Loading"/>
    </div>
  </body>

  <script type="text/javascript" src="dummy-data.js"></script>
  <script type="text/javascript">

    const backdrop = document.querySelector('.backdrop');
    const totalTaxiElem = document.getElementById('total-taxi');
    const timestampTaxi = document.getElementById('timestamp-taxi');

  const deckgl = new deck.DeckGL({
    container: 'container',
    mapStyle: 'https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json',
    initialViewState: {
      longitude: 103.703010666667,
      latitude: 1.3374685,
      zoom: 14,
      pitch: 0,
      bearing: 0,
    },
    controller: true,
    getTooltip: function({object}){
      return (
        object &&
        `\
        Longitude: ${object[0]}
        Latitude: ${object[1]}
        `
      );
    },
    layers: []
  });

  function setScatterPlot(data){
    deckgl.setProps({ layers: [
      new deck.ScatterplotLayer({
        data: data,
        opacity: 0.4,
        radiusScale: 2,
        radiusMinPixels: 1,
        wrapLongitude: true,

        getPosition: (d) => [d[0], d[1]],
        getRadius: () => 20,
        getFillColor: () => {
          return [160, 160, 160];
        },

        pickable: true,
      })
      ]})
  }

  function formatTimestamp(timestamp){
    var timestampDate = new Date(timestamp);
    var dateString = timestampDate.toTimeString().slice(0, 8);
    var result = `${timestampDate.toISOString().slice(0, 10)} ${dateString}`
    return result;
  }


  function loadData(date = ''){
    backdrop.style.display = 'flex'
    var params = '';
    if(date){
      params = `?date_time=${date}`
    }

    return fetch('https://api.data.gov.sg/v1/transport/taxi-availability' + params)
    .then(res => res.json())
    .then((res) => {
      console.log({ res });
      if(res.features){
        var feature = res.features[0]
        var data = feature.geometry.coordinates;
        var property = feature.properties;
        var totalTaxi = property.taxi_count
        var timestamp = property.timestamp;

        totalTaxiElem.innerHTML = `Total Taxi: ${totalTaxi}`;
        timestampTaxi.innerHTML = `Timestamp: ${formatTimestamp(timestamp)}`
        setScatterPlot(data);
      }else{
        setScatterPlot([]);
        totalTaxiElem.innerHTML = `Total Taxi: 0`;
        timestampTaxi.innerHTML = `Timestamp: -`
      }
    })
    .catch((err) => {
      console.log('Error on load data', { err });
      alert('An error occured when load data')
    })
    .finally(() => {
      setTimeout(() => {
        backdrop.style.display = 'none'
      }, 1000)
    })
  }


  flatpickr("#my-datepicker", {
    enableTime: true,
    dateFormat: "Y-m-d H:i",
    maxDate: new Date(),
    onClose: function(selectedDates, dateStr, instance){
      console.log('onClose', {selectedDates, dateStr, instance})
      var date = selectedDates[0].toISOString().slice(0, 19);
      loadData(date);
    },
    minuteIncrement: 60,
    });

    loadData();
  </script>
</html>
